<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Ücretsiz Nöbet Hazırlama Programı (Mazeretli) -farukguler.com</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <style>
        .progress-bar { transition: width 0.5s ease-in-out; }
        .hafta-sonu { background-color: #fef2f2; }
        [contenteditable="true"] { border-bottom: 1px dashed #3b82f6; padding: 2px 4px; min-width: 100px; }
        .takvim-gunu { cursor: pointer; transition: all 0.2s; }
        .takvim-gunu:hover { transform: scale(1.05); }
        .mazeret-secili { background-color: #080808; border-color: #121111; }
        .adim-aktif { background-color: #3b82f6; color: white; }
        .adim-pasif { background-color: #e5e7eb; color: #6b7280; }
        .toast {
            position: fixed; top: 20px; right: 20px; z-index: 1000;
            padding: 12px 16px; border-radius: 4px; color: white;
        }
        .mazeret-aciklama {
            border: 1px solid #d1d5db; padding: 0.25rem 0.5rem;
            font-size: 0.875rem; border-radius: 0.25rem;
            width: 100%;
        }
        @media (max-width: 640px) {
            .takvim-gunu { padding: 0.1rem; font-size: 0.6rem; }
            .mobile-table { display: block; overflow-x: auto; white-space: nowrap; }
            .takvim-baslik div { font-size: 0.6rem; }
        }

        /* Gece Modu Stilleri */
        .dark {
            --bg-color: #0F172A;
            --text-color: #E2E8F0;
            --card-bg: #1E293B;
            --border-color: #334155;
        }

        .dark body {
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        .dark .bg-white {
            background-color: var(--card-bg) !important;
        }

        .dark .bg-gray-100 {
            background-color: #1E293B !important;
        }

        .dark .text-gray-800,
        .dark .text-gray-700,
        .dark .text-gray-600 {
            color: #E2E8F0 !important;
        }

        .dark .border-gray-200 {
            border-color: #334155 !important;
        }

        .dark .hafta-sonu {
            background-color: #1E1E2D !important;
        }

        .dark .mazeret-secili {
            background-color: #4C1D1D !important;
            border-color: #7F1D1D !important;
        }

        .dark .takvim-gunu {
            background-color: #334155;
            color: #E2E8F0;
            border-color: #475569;
        }

        .dark .takvim-gunu:hover {
            background-color: #475569;
        }

        .dark .bg-blue-100 {
            background-color: #1E3A8A !important;
        }

        .dark .toast {
            background-color: #1E40AF !important;
        }

        .dark #personelModal,
        .dark #mazeretModal {
            background-color: rgba(15, 23, 42, 0.9);
        }

        .dark .modal-content {
            background-color: #1E293B;
            color: #E2E8F0;
            border-color: #334155;
        }

        .dark input,
        .dark select,
        .dark textarea {
            background-color: #334155;
            color: #E2E8F0;
            border-color: #475569;
        }

        .dark .bg-blue-500 {
            background-color: #1E40AF;
        }
        .dark .bg-blue-500:hover {
            background-color: #1E3A8A;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="toast" class="toast hidden"></div>
    
    <div class="container mx-auto p-4 md:p-6">
        <div class="bg-white shadow-lg rounded-lg overflow-hidden">
            <!-- Başlık -->
            <div class="bg-blue-600 text-white p-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold flex items-center">
                    <i class="ri-calendar-todo-fill mr-3"></i>Nöbet Hazırlama Programı (Mazeretli) -farukguler.com
                </h1>
                <div class="flex items-center gap-2">
                    <button id="themeToggle" class="hover:bg-blue-700 p-2 rounded-full">
                        <i class="ri-moon-line" id="themeIcon"></i>
                    </button>
                    <button id="yardimBtn" class="hover:bg-blue-700 p-2 rounded-full">
                        <i class="ri-question-line"></i>
                    </button>
                </div>
            </div>

            <!-- Adım Göstergesi -->
            <div class="p-4 md:p-6">
                <div class="flex mb-6">
                    <div class="flex-1 flex items-center">
                        <div id="adim1" class="w-8 h-8 rounded-full flex items-center justify-center adim-aktif">1</div>
                        <div class="ml-2 text-sm font-medium">Ayarlar</div>
                    </div>
                    <div class="flex-1 flex items-center">
                        <div id="adim2" class="w-8 h-8 rounded-full flex items-center justify-center adim-pasif">2</div>
                        <div class="ml-2 text-sm text-gray-500">Personel</div>
                    </div>
                    <div class="flex-1 flex items-center">
                        <div id="adim3" class="w-8 h-8 rounded-full flex items-center justify-center adim-pasif">3</div>
                        <div class="ml-2 text-sm text-gray-500">Sonuç</div>
                    </div>
                </div>

                <!-- Adım 1: Ayarlar -->
                <div id="girisAdimi" class="space-y-4">
                    <h2 class="text-xl font-semibold flex items-center">
                        <i class="ri-settings-2-line mr-2"></i> Planlama Ayarları
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block mb-1 text-sm font-medium">Başlangıç Tarihi</label>
                            <input type="date" id="baslangicTarihi" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block mb-1 text-sm font-medium">Bitiş Tarihi</label>
                            <input type="date" id="bitisTarihi" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block mb-1 text-sm font-medium">Vardiya Başına Personel</label>
                            <input type="number" id="nobetciSayisi" min="1" value="1" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block mb-1 text-sm font-medium">Maks. Üst Üste Nöbet</label>
                            <input type="number" id="ustUsteNobetSayisi" min="1" value="2" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block mb-1 text-sm font-medium">Min. Nöbet Aralığı (Gün)</label>
                            <input type="number" id="nobetArasiGun" min="0" value="3" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="flex items-end">
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="haftaSonuAyri" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500" checked>
                                <span class="text-sm">Hafta Sonu Ayrı Kontrol</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Adım 2: Personel -->
                <div id="personelAdimi" class="mt-8 hidden">
                    <h2 class="text-xl font-semibold flex items-center mb-4">
                        <i class="ri-team-line mr-2"></i> Personel Yönetimi
                    </h2>

                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-2">
                            <div>
                                <span class="font-medium">Kayıtlı Personel: </span>
                                <span id="toplamPersonelSayisi" class="font-bold text-blue-600">0</span>
                            </div>
                            <div class="flex space-x-2">
                                <button id="personelEkleBtn" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 md:px-4 md:py-2 rounded flex items-center">
                                    <i class="ri-user-add-line mr-1"></i><span class="text-sm md:text-base">Personel Ekle</span>
                                </button>
                                <button id="personelIcerikAktarBtn" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 md:px-4 md:py-2 rounded flex items-center">
                                    <i class="ri-upload-line mr-1"></i><span class="text-sm md:text-base">İçe Aktar</span>
                                </button>
                                <button id="personelDisariAktarBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 md:px-4 md:py-2 rounded flex items-center">
                                    <i class="ri-download-line mr-1"></i><span class="text-sm md:text-base">Dışa Aktar</span>
                                </button>
                            </div>
                        </div>

                        <div class="overflow-x-auto mobile-table">
                            <table class="w-full border-collapse">
                                <thead class="bg-blue-100">
                                    <tr>
                                        <th class="p-2 text-left text-sm">İsim</th>
                                        <th class="p-2 text-center text-sm">Nöbet</th>
                                        <th class="p-2 text-center text-sm">H.Sonu</th>
                                        <th class="p-2 text-center text-sm">Mazeretler</th>
                                        <th class="p-2 text-center text-sm">İşlemler</th>
                                    </tr>
                                </thead>
                                <tbody id="personelListesi" class="divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium">Toplam Nöbet:</span>
                                <span id="nobetDurumu" class="font-bold">0/0</span>
                            </div>
                            <div class="mt-2 h-2 bg-gray-200 rounded-full">
                                <div id="nobetProgress" class="h-full bg-blue-500 rounded-full progress-bar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium">Hafta Sonu Nöbet:</span>
                                <span id="haftaSonuNobetDurumu" class="font-bold">0/0</span>
                            </div>
                            <div class="mt-2 h-2 bg-gray-200 rounded-full">
                                <div id="haftaSonuProgress" class="h-full bg-red-500 rounded-full progress-bar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Adım 3: Sonuçlar -->
                <div id="sonucAdimi" class="mt-8 hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-2">
                        <h2 class="text-xl font-semibold flex items-center">
                            <i class="ri-calendar-todo-line mr-2"></i>Nöbet Programı
                        </h2>
                        <div class="flex space-x-2">
                            <button id="excelAktarBtn" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 md:px-4 md:py-2 rounded flex items-center">
                                <i class="ri-file-excel-2-line mr-1"></i><span class="text-sm md:text-base">Excel'e Aktar</span>
                            </button>
                            <button id="yenidenOlusturBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 md:px-4 md:py-2 rounded flex items-center">
                                <i class="ri-refresh-line mr-1"></i><span class="text-sm md:text-base">Yeniden Oluştur</span>
                            </button>
                        </div>
                    </div>

                    <div class="overflow-x-auto mobile-table">
                        <table class="w-full border-collapse">
                            <thead class="bg-blue-100">
                                <tr>
                                    <th class="p-2 text-left text-sm">Tarih</th>
                                    <th class="p-2 text-left text-sm">Gün</th>
                                    <th class="p-2 text-left text-sm">Nöbetçiler</th>
                                    <th class="p-2 text-left text-sm">Notlar & Mazeretler</th>
                                </tr>
                            </thead>
                            <tbody id="sonucListesi" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Navigasyon -->
                <div class="mt-8 flex justify-between">
                    <button id="geriBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded flex items-center hidden">
                        <i class="ri-arrow-left-line mr-2"></i>Geri
                    </button>
                    <button id="devamBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded flex items-center ml-auto">
                        İleri <i class="ri-arrow-right-line ml-2"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modaller -->
    <div id="personelModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg w-full max-w-md">
            <div class="p-4 border-b">
                <h2 class="text-xl font-semibold" id="personelModalBaslik">Personel Ekle</h2>
            </div>
            <div class="p-4">
                <input type="text" id="personelAdi" placeholder="Personel Adı Soyadı" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="p-4 border-t flex justify-end space-x-2">
                <button onclick="kapatModal('personelModal')" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
                    İptal
                </button>
                <button onclick="personelKaydet()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                    Kaydet
                </button>
            </div>
        </div>
    </div>

    <div id="mazeretModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="p-4 border-b sticky top-0 bg-white z-10">
                <h2 class="text-xl font-semibold">Mazeret Günleri Ekle/Düzenle</h2>
                <p class="text-sm text-gray-600" id="mazeretPersonelAdi"></p>
            </div>
            <div class="p-4">
                <div class="mb-4">
                    <label class="block mb-2 text-sm font-medium">Mazeret Günlerini Seçin</label>
                    <div class="grid grid-cols-7 gap-1 mb-2 text-xs font-medium">
                        <div class="text-center text-red-600">Paz</div>
                        <div class="text-center">Pzt</div>
                        <div class="text-center">Sal</div>
                        <div class="text-center">Çar</div>
                        <div class="text-center">Per</div>
                        <div class="text-center">Cum</div>
                        <div class="text-center text-red-600">Cmt</div>
                    </div>
                    <div id="takvim" class="grid grid-cols-7 gap-1"></div>
                </div>
                <div class="border rounded-lg p-3 max-h-96 overflow-y-auto">
                    <h3 class="text-sm font-medium mb-2">Seçili Mazeret Günleri:</h3>
                    <div id="mazeretListesi" class="space-y-2"></div>
                </div>
            </div>
            <div class="p-4 border-t flex justify-between sticky bottom-0 bg-white">
                <button onclick="mazeretleriTemizle()" class="text-red-500 hover:text-red-700 text-sm flex items-center">
                    <i class="ri-delete-bin-line mr-1"></i> Tümünü Sil
                </button>
                <div class="flex space-x-2">
                    <button onclick="kapatModal('mazeretModal')" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
                        Kapat
                    </button>
                    <button onclick="mazeretKaydet()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                        Kaydet
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global Değişkenler
        let personeller = [];
        let seciliPersonelIndex = -1;
        let mevcutAdim = 0;
        const adimlar = ['girisAdimi', 'personelAdimi', 'sonucAdimi'];
        let duzenlemeModu = false;
        let seciliMazeretGunleri = new Set();
        let takvimGunleri = [];
        let mazeretAciklamalari = {}; // Mazeret açıklamalarını saklamak için

        // Sayfa yüklendiğinde
        document.addEventListener('DOMContentLoaded', function() {
            const bugun = new Date();
            const birAySonra = new Date();
            birAySonra.setMonth(birAySonra.getMonth() + 1);
            
            const bugunStr = bugun.toISOString().split('T')[0];
            document.getElementById('baslangicTarihi').value = bugunStr;
            document.getElementById('baslangicTarihi').min = bugunStr;
            document.getElementById('bitisTarihi').value = birAySonra.toISOString().split('T')[0];
            document.getElementById('bitisTarihi').min = bugunStr;
            
            // Event listener'ları ekle
            initEventListeners();

            // Tema kontrolü
            const savedTheme = localStorage.getItem('theme') || 'light';
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (savedTheme === 'dark' || (savedTheme === 'system' && systemPrefersDark)) {
                document.documentElement.classList.add('dark');
                document.getElementById('themeIcon').classList.replace('ri-moon-line', 'ri-sun-line');
            }
        });

        // Event listener'ları başlat
        function initEventListeners() {
            document.getElementById('baslangicTarihi').addEventListener('change', function() {
                const baslangic = this.value;
                document.getElementById('bitisTarihi').min = baslangic;
                if(document.getElementById('bitisTarihi').value < baslangic) {
                    document.getElementById('bitisTarihi').value = baslangic;
                }
            });
            
            document.getElementById('personelEkleBtn').addEventListener('click', function() {
                duzenlemeModu = false;
                document.getElementById('personelModalBaslik').textContent = 'Personel Ekle';
                document.getElementById('personelAdi').value = '';
                document.getElementById('personelModal').classList.remove('hidden');
                document.getElementById('personelAdi').focus();
            });
            
            document.getElementById('devamBtn').addEventListener('click', handleDevamBtn);
            document.getElementById('geriBtn').addEventListener('click', handleGeriBtn);
            document.getElementById('yenidenOlusturBtn').addEventListener('click', nobetListesiOlustur);
            document.getElementById('excelAktarBtn').addEventListener('click', excelAktar);
            document.getElementById('personelDisariAktarBtn').addEventListener('click', personelDisariAktar);
            document.getElementById('personelIcerikAktarBtn').addEventListener('click', personelIcerikAktar);
            document.getElementById('yardimBtn').addEventListener('click', showHelp);
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
        }

        // Tema değiştirme fonksiyonu
        function toggleTheme() {
            const html = document.documentElement;
            const icon = document.getElementById('themeIcon');
            
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                icon.classList.replace('ri-sun-line', 'ri-moon-line');
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                icon.classList.replace('ri-moon-line', 'ri-sun-line');
            }
        }

        // Toast bildirimi göster
        function showToast(message, type = "info") {
            const toast = document.getElementById('toast');
            toast.innerHTML = message;
            
            if (document.documentElement.classList.contains('dark')) {
                const colors = {
                    error: 'bg-red-700',
                    success: 'bg-green-700',
                    info: 'bg-blue-700'
                };
                toast.className = `toast ${colors[type]}`;
            } else {
                const colors = {
                    error: 'bg-red-500',
                    success: 'bg-green-500',
                    info: 'bg-blue-500'
                };
                toast.className = `toast ${colors[type]}`;
            }
            
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // Personel Ekleme/Düzenleme
        function personelKaydet() {
            const ad = document.getElementById('personelAdi').value.trim();
            if(ad) {
                if(duzenlemeModu) {
                    personeller[seciliPersonelIndex].ad = escapeHtml(ad);
                    showToast("Personel başarıyla güncellendi", "success");
                } else {
                    personeller.push({
                        ad: escapeHtml(ad),
                        nobetSayisi: 0,
                        haftaSonuNobetSayisi: 0,
                        mazeretler: [],
                        sonNobet: null,
                        ustusteNobet: 0
                    });
                    showToast("Personel başarıyla eklendi", "success");
                }
                personelListesiniGuncelle();
                kapatModal('personelModal');
                document.getElementById('personelAdi').value = '';
                nobetDagilimKontrol();
            } else {
                showToast("Lütfen personel adını giriniz!", "error");
            }
        }

        // Personel Silme
        function personelSil(index) {
            if(confirm(`${personeller[index].ad} isimli personeli silmek istediğinize emin misiniz?`)) {
                personeller.splice(index, 1);
                personelListesiniGuncelle();
                nobetDagilimKontrol();
                showToast("Personel başarıyla silindi", "success");
            }
        }

        // Takvim oluşturma
        function takvimOlustur() {
            const baslangic = new Date(document.getElementById('baslangicTarihi').value);
            const bitis = new Date(document.getElementById('bitisTarihi').value);
            
            if(!baslangic || !bitis || baslangic > bitis) {
                showToast("Lütfen geçerli bir tarih aralığı seçiniz!", "error");
                return;
            }
            
            const takvim = document.getElementById('takvim');
            takvim.innerHTML = '';
            takvimGunleri = [];
            seciliMazeretGunleri = new Set();
            
            if(seciliPersonelIndex >= 0) {
                personeller[seciliPersonelIndex].mazeretler.forEach(m => {
                    seciliMazeretGunleri.add(m.tarih);
                    mazeretAciklamalari[m.tarih] = m.aciklama; // Açıklamaları global değişkene yükle
                });
            }
            
            const gunIsimleri = ['Paz', 'Pzt', 'Sal', 'Çar', 'Per', 'Cum', 'Cmt'];
            const gunler = [];
            
            // Ayın ilk gününün haftanın hangi günü olduğunu bul
            const ilkGun = new Date(baslangic);
            const baslangicGunu = ilkGun.getDay(); // 0-6 arası (0=Pazar)
            
            // Boşlukları doldur (ayın ilk gününden önceki boş hücreler)
            for(let i = 0; i < baslangicGunu; i++) {
                const bosHucre = document.createElement('div');
                bosHucre.className = 'p-1';
                takvim.appendChild(bosHucre);
            }
            
            // Tarih aralığını oluştur
            for(let d = new Date(baslangic); d <= bitis; d.setDate(d.getDate() + 1)) {
                const gunStr = d.toISOString().split('T')[0];
                const gunNo = d.getDay();
                const gunAdi = gunIsimleri[gunNo];
                const gunNumarasi = d.getDate();
                const isHaftaSonu = gunNo === 0 || gunNo === 6;
                
                const gunElement = document.createElement('div');
                gunElement.className = `text-center p-1 text-xs border rounded takvim-gunu ${
                    isHaftaSonu ? 'text-red-600 bg-red-50' : 'bg-white'
                } ${
                    seciliMazeretGunleri.has(gunStr) ? 'mazeret-secili' : 'hover:bg-gray-100'
                }`;
                gunElement.innerHTML = `
                    <div>${gunAdi}</div>
                    <div>${gunNumarasi}</div>
                `;
                gunElement.dataset.tarih = gunStr;
                gunElement.onclick = function() {
                    if(seciliMazeretGunleri.has(gunStr)) {
                        seciliMazeretGunleri.delete(gunStr);
                        delete mazeretAciklamalari[gunStr]; // Açıklamayı da sil
                        this.classList.remove('mazeret-secili');
                    } else {
                        seciliMazeretGunleri.add(gunStr);
                        this.classList.add('mazeret-secili');
                    }
                    mazeretListesiniGuncelle();
                };
                
                takvim.appendChild(gunElement);
                takvimGunleri.push(gunStr);
            }
            
            mazeretListesiniGuncelle();
        }

        // Mazeret Listesini Güncelle
        function mazeretListesiniGuncelle() {
            const liste = document.getElementById('mazeretListesi');
            liste.innerHTML = '';
            
            const sortedMazeretler = Array.from(seciliMazeretGunleri).sort((a, b) => 
                new Date(a) - new Date(b)
            );
            
            if(sortedMazeretler.length === 0) {
                liste.innerHTML = '<div class="text-gray-500 text-sm italic">Henüz mazeret günü seçilmedi</div>';
                return;
            }
            
            sortedMazeretler.forEach(tarih => {
                const div = document.createElement('div');
                div.className = 'flex flex-col space-y-2 text-sm p-2 border rounded mb-2';
                
                const tarihRow = document.createElement('div');
                tarihRow.className = 'flex justify-between items-center';
                tarihRow.innerHTML = `
                    <span class="font-medium">${formatDate(tarih)}</span>
                    <button onclick="mazeretSil('${tarih}')" class="text-red-500 hover:text-red-700">
                        <i class="ri-close-line"></i>
                    </button>
                `;
                
                const aciklamaDiv = document.createElement('div');
                aciklamaDiv.className = 'flex flex-col';
                
                // Açıklama için öncelik sırası:
                // 1. Global değişkende saklanan değer
                // 2. Personel verisindeki mevcut açıklama
                // 3. Boş değer
                const mevcutAciklama = mazeretAciklamalari[tarih] || 
                                      (seciliPersonelIndex >= 0 ? 
                                       personeller[seciliPersonelIndex].mazeretler.find(m => m.tarih === tarih)?.aciklama : 
                                       '');
                
                aciklamaDiv.innerHTML = `
                    <label class="text-xs text-gray-500 mb-1">Mazeret Açıklaması:</label>
                    <input type="text" class="mazeret-aciklama" 
                           data-tarih="${tarih}" 
                           placeholder="Mazeret sebebini yazın" 
                           value="${mevcutAciklama || ''}"
                           oninput="mazeretAciklamaGuncelle('${tarih}', this.value)">
                `;
                
                div.appendChild(tarihRow);
                div.appendChild(aciklamaDiv);
                liste.appendChild(div);
            });
        }

        // Mazeret açıklaması güncellendiğinde çağrılacak fonksiyon
        function mazeretAciklamaGuncelle(tarih, deger) {
            mazeretAciklamalari[tarih] = deger;
        }

        // Mazeret Silme
        function mazeretSil(tarih) {
            seciliMazeretGunleri.delete(tarih);
            delete mazeretAciklamalari[tarih]; // Açıklamayı da sil
            document.querySelectorAll(`#takvim [data-tarih="${tarih}"]`).forEach(el => {
                el.classList.remove('mazeret-secili');
            });
            mazeretListesiniGuncelle();
        }

        // Tüm Mazeretleri Temizle
        function mazeretleriTemizle() {
            if(confirm("Tüm mazeret günlerini silmek istediğinize emin misiniz?")) {
                seciliMazeretGunleri = new Set();
                mazeretAciklamalari = {}; // Tüm açıklamaları temizle
                document.querySelectorAll('#takvim .mazeret-secili').forEach(el => {
                    el.classList.remove('mazeret-secili');
                });
                mazeretListesiniGuncelle();
            }
        }

        // Mazeret Kaydetme
        function mazeretKaydet() {
            if(seciliPersonelIndex >= 0) {
                personeller[seciliPersonelIndex].mazeretler = Array.from(seciliMazeretGunleri).map(tarih => {
                    return {
                        tarih: tarih,
                        tur: 'genel',
                        aciklama: mazeretAciklamalari[tarih] || formatDate(tarih)
                    };
                });
                
                personelListesiniGuncelle();
                kapatModal('mazeretModal');
                nobetDagilimKontrol();
                showToast("Mazeretler başarıyla kaydedildi", "success");
            }
        }

        // Modal açılırken çağrılacak fonksiyon
        window.mazeretModalAc = function(index) {
            seciliPersonelIndex = index;
            document.getElementById('mazeretPersonelAdi').textContent = personeller[index].ad;
            document.getElementById('mazeretModal').classList.remove('hidden');
            
            // Global değişkenleri personel verisiyle doldur
            seciliMazeretGunleri = new Set();
            mazeretAciklamalari = {};
            personeller[index].mazeretler.forEach(m => {
                seciliMazeretGunleri.add(m.tarih);
                mazeretAciklamalari[m.tarih] = m.aciklama;
            });
            
            takvimOlustur();
        };

        // Personel Listesini Güncelleme
        function personelListesiniGuncelle() {
            const tbody = document.getElementById('personelListesi');
            tbody.innerHTML = '';
            
            personeller.forEach((personel, index) => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                
                const mazeretSayisi = personel.mazeretler.length;
                const mazeretText = mazeretSayisi > 0 ? 
                    `<span class="text-xs px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full cursor-pointer" onclick="mazeretModalAc(${index})">${mazeretSayisi} Gün</span>` :
                    '<span class="text-xs px-2 py-1 text-gray-500">0 Gün</span>';
                
                tr.innerHTML = `
                    <td class="p-2">
                        <div contenteditable="true" onblur="personelAdiGuncelle(${index}, this.textContent)">${personel.ad}</div>
                    </td>
                    <td class="p-2 text-center">${personel.nobetSayisi}</td>
                    <td class="p-2 text-center">${personel.haftaSonuNobetSayisi}</td>
                    <td class="p-2 text-center">
                        ${mazeretText}
                    </td>
                    <td class="p-2 text-center">
                        <div class="flex justify-center space-x-1">
                            <button onclick="mazeretModalAc(${index})" class="text-yellow-600 hover:bg-yellow-100 p-2 rounded" title="Mazeret Ekle">
                                <i class="ri-calendar-close-line"></i>
                            </button>
                            <button onclick="personelSil(${index})" class="text-red-600 hover:bg-red-100 p-2 rounded" title="Personeli Sil">
                                <i class="ri-delete-bin-line"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            document.getElementById('toplamPersonelSayisi').textContent = personeller.length;
        }

        // Personel Adı Güncelleme
        function personelAdiGuncelle(index, yeniAd) {
            const safeAd = escapeHtml(yeniAd.trim());
            if(safeAd !== '') {
                personeller[index].ad = safeAd;
                personelListesiniGuncelle();
            } else {
                const hucre = document.querySelector(`#personelListesi tr:nth-child(${index+1}) td:first-child div`);
                hucre.textContent = personeller[index].ad;
                showToast("Personel adı boş olamaz!", "error");
            }
        }

        // Nöbet Dağılım Kontrolü
        function nobetDagilimKontrol() {
            const baslangic = new Date(document.getElementById('baslangicTarihi').value);
            const bitis = new Date(document.getElementById('bitisTarihi').value);
            const nobetciSayisi = parseInt(document.getElementById('nobetciSayisi').value) || 1;
            
            if(!baslangic || !bitis || personeller.length === 0) return;
            
            const gunler = [];
            for(let d = new Date(baslangic); d <= bitis; d.setDate(d.getDate() + 1)) {
                gunler.push(new Date(d));
            }
            
            const gunSayisi = gunler.length;
            const haftaSonuSayisi = gunler.filter(g => [0,6].includes(g.getDay())).length;
            
            const toplamNobet = gunSayisi * nobetciSayisi;
            const toplamHSNobet = haftaSonuSayisi * nobetciSayisi;
            
            document.getElementById('nobetDurumu').textContent = `0/${toplamNobet}`;
            document.getElementById('haftaSonuNobetDurumu').textContent = `0/${toplamHSNobet}`;
            
            document.getElementById('nobetProgress').style.width = '0%';
            document.getElementById('haftaSonuProgress').style.width = '0%';
        }

        // Nöbet Listesi Oluşturma
        function nobetListesiOlustur() {
            const baslangic = new Date(document.getElementById('baslangicTarihi').value);
            const bitis = new Date(document.getElementById('bitisTarihi').value);
            const nobetciSayisi = parseInt(document.getElementById('nobetciSayisi').value) || 1;
            const maxConsec = parseInt(document.getElementById('ustUsteNobetSayisi').value) || 2;
            const minDaysBetween = parseInt(document.getElementById('nobetArasiGun').value) || 3;
            const haftaSonuAyri = document.getElementById('haftaSonuAyri').checked;

            // Validasyonlar
            if(!baslangic || !bitis) {
                showToast("Lütfen tarih aralığını seçiniz!", "error");
                return false;
            }

            if(new Date(baslangic) > new Date(bitis)) {
                showToast("Bitiş tarihi başlangıçtan önce olamaz!", "error");
                return false;
            }

            if(personeller.length < nobetciSayisi) {
                showToast(`En az ${nobetciSayisi} personel gereklidir!`, "error");
                return false;
            }

            // Personel verilerini sıfırla
            personeller.forEach(p => {
                p.nobetSayisi = 0;
                p.haftaSonuNobetSayisi = 0;
                p.sonNobet = null;
                p.ustusteNobet = 0;
            });

            const sonucListesi = document.getElementById('sonucListesi');
            sonucListesi.innerHTML = '';

            // Tarih aralığını oluştur
            const gunler = [];
            for(let d = new Date(baslangic); d <= bitis; d.setDate(d.getDate() + 1)) {
                gunler.push(new Date(d));
            }

            // Her gün için nöbetçi atama
            gunler.forEach(gun => {
                const gunStr = gun.toISOString().split('T')[0];
                const gunNo = gun.getDay();
                const isHaftaSonu = gunNo === 0 || gunNo === 6;
                
                // Uygun personelleri filtrele
                let eligiblePersoneller = personeller.filter(p => {
                    if(p.mazeretler.some(m => m.tarih === gunStr)) return false;
                    if(p.sonNobet && (gun - p.sonNobet) / (1000*60*60*24) <= minDaysBetween) return false;
                    if(p.ustusteNobet >= maxConsec) return false;
                    return true;
                });

                // Yeterli personel yoksa uyarı ver
                if(eligiblePersoneller.length < nobetciSayisi) {
                    const tr = document.createElement('tr');
                    tr.className = isHaftaSonu ? 'hafta-sonu' : '';
                    tr.innerHTML = `
                        <td class="p-2">${formatDate(gunStr)}</td>
                        <td class="p-2 ${isHaftaSonu ? 'text-red-600 font-medium' : ''}">${['Pazar', 'Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi'][gunNo]}</td>
                        <td class="p-2">-</td>
                        <td class="p-2 text-xs text-red-500">Yeterli personel bulunamadı</td>
                    `;
                    sonucListesi.appendChild(tr);
                    return;
                }

                // Hafta sonu ayrı kontroller
                if(haftaSonuAyri && isHaftaSonu) {
                    eligiblePersoneller.sort((a, b) => {
                        const diffHS = a.haftaSonuNobetSayisi - b.haftaSonuNobetSayisi;
                        if(diffHS !== 0) return diffHS;
                        
                        const diffTotal = a.nobetSayisi - b.nobetSayisi;
                        if(diffTotal !== 0) return diffTotal;
                        
                        return (a.sonNobet || 0) - (b.sonNobet || 0);
                    });
                } else {
                    eligiblePersoneller.sort((a, b) => {
                        const diffTotal = a.nobetSayisi - b.nobetSayisi;
                        if(diffTotal !== 0) return diffTotal;
                        
                        return (a.sonNobet || 0) - (b.sonNobet || 0);
                    });
                }

                // Eşit sayıda nöbet tutanlar için rastgele sıralama
                if(eligiblePersoneller.length > 1) {
                    const firstNobetCount = eligiblePersoneller[0].nobetSayisi;
                    const sameCountGroup = eligiblePersoneller.filter(p => p.nobetSayisi === firstNobetCount);
                    
                    if(sameCountGroup.length > 1) {
                        const shuffled = sameCountGroup.sort(() => 0.5 - Math.random());
                        eligiblePersoneller = [...shuffled, ...eligiblePersoneller.slice(shuffled.length)];
                    }
                }

                // Nöbetçileri seç
                const secilenler = [];
                for(let i = 0; i < nobetciSayisi && i < eligiblePersoneller.length; i++) {
                    const personel = eligiblePersoneller[i];
                    personel.nobetSayisi++;
                    if(isHaftaSonu) personel.haftaSonuNobetSayisi++;
                    
                    if(personel.sonNobet && (gun - personel.sonNobet)/(1000*60*60*24) === 1) {
                        personel.ustusteNobet++;
                    } else {
                        personel.ustusteNobet = 1;
                    }
                    
                    personel.sonNobet = new Date(gun);
                    secilenler.push(personel.ad);
                }

                // Tabloya ekle
                const tr = document.createElement('tr');
                tr.className = isHaftaSonu ? 'hafta-sonu' : '';
                
                const gunAdi = ['Pazar', 'Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi'][gunNo];
                const tarihStr = formatDate(gun);
                
                // Mazeretli personelleri bul
                const mazeretliler = personeller.filter(p => 
                    p.mazeretler.some(m => m.tarih === gunStr))
                    .map(p => {
                        const mazeret = p.mazeretler.find(m => m.tarih === gunStr);
                        return `${p.ad}${mazeret.aciklama ? ` (${mazeret.aciklama})` : ''}`;
                    });
                
                tr.innerHTML = `
                    <td class="p-2">${tarihStr}</td>
                    <td class="p-2 ${isHaftaSonu ? 'text-red-600 font-medium' : ''}">${gunAdi}</td>
                    <td class="p-2">${secilenler.join(', ') || '-'}</td>
                    <td class="p-2 text-xs text-gray-500">
                        ${secilenler.length === 0 ? 'Uygun personel bulunamadı' : ''}
                        ${mazeretliler.length > 0 ? `<div class="mt-1"><span class="text-yellow-600">Mazeretliler:</span> ${mazeretliler.join(', ')}</div>` : ''}
                    </td>
                `;
                sonucListesi.appendChild(tr);
            });

            // İstatistikleri güncelle
            const toplamNobet = gunler.length * nobetciSayisi;
            const toplamHSNobet = gunler.filter(g => [0,6].includes(g.getDay())).length * nobetciSayisi;
            const atananNobet = personeller.reduce((a, b) => a + b.nobetSayisi, 0);
            const atananHSNobet = personeller.reduce((a, b) => a + b.haftaSonuNobetSayisi, 0);
            
            document.getElementById('nobetDurumu').textContent = `${atananNobet}/${toplamNobet}`;
            document.getElementById('haftaSonuNobetDurumu').textContent = `${atananHSNobet}/${toplamHSNobet}`;
            
            document.getElementById('nobetProgress').style.width = `${Math.min(100, (atananNobet/toplamNobet)*100)}%`;
            document.getElementById('haftaSonuProgress').style.width = `${Math.min(100, (atananHSNobet/toplamHSNobet)*100)}%`;
            
            showToast("Nöbet programı başarıyla oluşturuldu", "success");
            return true;
        }

        // Excel Aktarım
        function excelAktar() {
            if(personeller.length === 0 || document.getElementById('sonucListesi').children.length === 0) {
                showToast("Excel'e aktarılacak veri bulunamadı!", "error");
                return;
            }
            
            try {
                const table = document.getElementById('sonucListesi');
                const workbook = XLSX.utils.table_to_book(table);
                
                // Personel bilgilerini ayrı bir sayfaya ekle
                let notes = [["PERSONEL BİLGİLERİ"], [""]];
                
                // Personel listesi
                notes.push(["PERSONEL LİSTESİ"]);
                personeller.forEach((p, i) => {
                    notes.push([`${i+1}. ${p.ad} - Toplam Nöbet: ${p.nobetSayisi} (Hafta Sonu: ${p.haftaSonuNobetSayisi})`]);
                });
                
                // Mazeretler
                notes.push(["", ""], ["MAZERETLER"]);
                personeller.forEach(p => {
                    if(p.mazeretler.length > 0) {
                        notes.push(["", ""], [`${p.ad}:`]);
                        const sortedMazeretler = [...p.mazeretler].sort((a, b) => new Date(a.tarih) - new Date(b.tarih));
                        sortedMazeretler.forEach(m => {
                            notes.push([`- ${m.aciklama} (${formatDate(m.tarih)})`]);
                        });
                    }
                });
                
                const notesWS = XLSX.utils.aoa_to_sheet(notes);
                XLSX.utils.book_append_sheet(workbook, notesWS, "Notlar & Mazeretler");
                
                // Dosyayı indir
                XLSX.writeFile(workbook, 'Nobet_Listesi.xlsx');
                showToast("Excel dosyası başarıyla oluşturuldu", "success");
            } catch (e) {
                console.error("Excel aktarım hatası:", e);
                showToast("Excel aktarımı sırasında bir hata oluştu!", "error");
            }
        }

        // Personel Dışa Aktar (Gelişmiş)
        function personelDisariAktar() {
            if(personeller.length === 0) {
                showToast("Dışa aktarılacak personel bulunamadı!", "error");
                return;
            }
            
            try {
                // Create headers with all necessary columns
                const headers = [
                    "Personel Adı", 
                    "Toplam Nöbet", 
                    "Hafta Sonu Nöbet", 
                    "Mazeret Sayısı",
                    "Mazeret Tarihleri",
                    "Mazeret Açıklamaları"
                ];
                
                // Prepare data rows
                const data = personeller.map(p => {
                    // Separate dates and explanations for better Excel processing
                    const mazeretTarihleri = p.mazeretler.map(m => m.tarih).join("; ");
                    const mazeretAciklamalari = p.mazeretler.map(m => m.aciklama).join("; ");
                    
                    return [
                        p.ad,
                        p.nobetSayisi,
                        p.haftaSonuNobetSayisi,
                        p.mazeretler.length,
                        mazeretTarihleri,
                        mazeretAciklamalari
                    ];
                });
                
                // Create workbook with both data and instructions
                const workbook = XLSX.utils.book_new();
                const worksheet = XLSX.utils.aoa_to_sheet([headers, ...data]);
                
                // Add instructions sheet
                const instructions = [
                    ["DİKKAT: Bu dosyayı düzenlerken lütfen aşağıdaki kurallara uyunuz"],
                    [""],
                    ["1. Sütun başlıklarını değiştirmeyiniz"],
                    ["2. Personel adlarını değiştirebilirsiniz (veya yeni yeni satıra ekleyin)"],
                    ["3. Mazeret tarihleri YYYY-AA-GG formatında olmalıdır (örnek: 2023-12-31)"],
                    ["4. Mazeret tarihlerini noktalı virgül (;) ile ayırabilirsiniz"],
                    ["5. Programı bozmamak için diğer sütunlardaki verileri değiştirmeyin"]
                ];
                const instructionSheet = XLSX.utils.aoa_to_sheet(instructions);
                
                XLSX.utils.book_append_sheet(workbook, worksheet, "Personeller");
                XLSX.utils.book_append_sheet(workbook, instructionSheet, "Talimatlar");
                
                XLSX.writeFile(workbook, 'Personel_Listesi.xlsx');
                showToast("Personel listesi başarıyla dışa aktarıldı", "success");
            } catch (e) {
                console.error("Dışa aktarım hatası:", e);
                showToast("Dışa aktarım sırasında bir hata oluştu!", "error");
            }
        }

        // Personel İçe Aktar (Gelişmiş)
        function personelIcerikAktar() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls,.csv';
            
            input.onchange = async e => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    const data = await readFileAsArrayBuffer(file);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Find the personel sheet (skip instruction sheet)
                    const personelSheetName = workbook.SheetNames.find(name => 
                        name.toLowerCase().includes('personel') || 
                        !name.toLowerCase().includes('talimat')
                    );
                    
                    if (!personelSheetName) {
                        showToast("Personel sayfası bulunamadı!", "error");
                        return;
                    }
                    
                    const worksheet = workbook.Sheets[personelSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (jsonData.length < 2) {
                        showToast("Excel dosyasında veri bulunamadı!", "error");
                        return;
                    }
                    
                    // Get column indexes from headers
                    const headers = jsonData[0].map(h => h.toString().toLowerCase().trim());
                    const adIndex = headers.findIndex(h => h.includes("personel") || h.includes("adı") || h.includes("ad"));
                    const nobetIndex = headers.findIndex(h => h.includes("toplam") || h.includes("nöbet"));
                    const hsNobetIndex = headers.findIndex(h => h.includes("hafta") || h.includes("sonu"));
                    const mazeretTarihIndex = headers.findIndex(h => h.includes("mazeret tarih"));
                    const mazeretAciklamaIndex = headers.findIndex(h => h.includes("mazeret açıklama"));
                    
                    if (adIndex === -1) {
                        showToast("Personel adı sütunu bulunamadı!", "error");
                        return;
                    }
                    
                    let basarili = 0;
                    let hatali = 0;
                    const yeniPersoneller = [];
                    
                    // Process data starting from row 1 (skip header)
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        try {
                            const ad = cleanPersonelName(row[adIndex]?.toString()?.trim());
                            
                            if (!ad || ad.length < 2) {
                                hatali++;
                                continue;
                            }
                            
                            const personel = {
                                ad: escapeHtml(ad),
                                nobetSayisi: parseInt(row[nobetIndex]) || 0,
                                haftaSonuNobetSayisi: parseInt(row[hsNobetIndex]) || 0,
                                mazeretler: [],
                                sonNobet: null,
                                ustusteNobet: 0
                            };
                            
                            // Process unavailability dates if columns exist
                            if (mazeretTarihIndex !== -1 && row[mazeretTarihIndex]) {
                                const tarihler = row[mazeretTarihIndex].toString().split(';').map(t => t.trim());
                                const aciklamalar = mazeretAciklamaIndex !== -1 && row[mazeretAciklamaIndex] ? 
                                    row[mazeretAciklamaIndex].toString().split(';').map(a => a.trim()) : 
                                    Array(tarihler.length).fill("Mazeret");
                                
                                tarihler.forEach((tarih, idx) => {
                                    if (tarih) {
                                        personel.mazeretler.push({
                                            tarih: formatDateForStorage(tarih),
                                            tur: 'genel',
                                            aciklama: aciklamalar[idx] || "Mazeret"
                                        });
                                    }
                                });
                            }
                            
                            yeniPersoneller.push(personel);
                            basarili++;
                            
                        } catch (e) {
                            hatali++;
                            console.error("Personel kaydı işlenirken hata:", e);
                        }
                    }

                    if (yeniPersoneller.length > 0) {
                        personeller = yeniPersoneller;
                        personelListesiniGuncelle();
                        nobetDagilimKontrol();
                        
                        let mesaj = `${basarili} personel başarıyla içe aktarıldı`;
                        if (hatali > 0) {
                            mesaj += ` (${hatali} geçersiz kayıt atlandı)`;
                        }
                        showToast(mesaj, "success");
                    } else {
                        showToast("İçe aktarılacak geçerli personel bulunamadı!", "error");
                    }
                    
                } catch (e) {
                    console.error("İçe aktarım hatası:", e);
                    showToast("Dosya okunamadı! Lütfen formatı kontrol edin.", "error");
                }
            };
            
            input.click();
        }

        // Yardımcı Fonksiyonlar
        function formatDateForStorage(dateString) {
            // Handle different date formats from Excel
            if (!dateString) return '';
            
            // Try ISO format first
            let d = new Date(dateString);
            if (!isNaN(d.getTime())) return d.toISOString().split('T')[0];
            
            // Try common Turkish date formats
            const turkishFormats = [
                /(\d{2})\.(\d{2})\.(\d{4})/, // DD.MM.YYYY
                /(\d{4})-(\d{2})-(\d{2})/,   // YYYY-MM-DD
                /(\d{2})\/(\d{2})\/(\d{4})/  // DD/MM/YYYY
            ];
            
            for (const format of turkishFormats) {
                const match = dateString.match(format);
                if (match) {
                    const day = match[1];
                    const month = match[2];
                    const year = match[3];
                    return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                }
            }
            
            // Fallback - return original if can't parse
            return dateString;
        }

        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(new Error("Dosya okunamadı"));
                reader.readAsArrayBuffer(file);
            });
        }

        function cleanPersonelName(name) {
            if (!name) return '';
            return name.toString()
                .replace(/[\/\\*\[\]{}:;|=<>]/g, '') // Remove special chars
                .replace(/^\s+|\s+$/g, '') // Trim
                .replace(/\s{2,}/g, ' ') // Collapse multiple spaces
                .split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join(' ');
        }

        // İleri Butonu İşlemi
        function handleDevamBtn() {
            if(mevcutAdim === 0) {
                const baslangic = document.getElementById('baslangicTarihi').value;
                const bitis = document.getElementById('bitisTarihi').value;
                
                if(!baslangic || !bitis) {
                    showToast("Lütfen başlangıç ve bitiş tarihlerini seçiniz!", "error");
                    return;
                }
                
                if(new Date(baslangic) > new Date(bitis)) {
                    showToast("Başlangıç tarihi bitiş tarihinden sonra olamaz!", "error");
                    return;
                }
                
                mevcutAdim++;
            } 
            else if(mevcutAdim === 1) {
                if(personeller.length === 0) {
                    showToast("Lütfen en az bir personel ekleyiniz!", "error");
                    return;
                }
                
                mevcutAdim++;
                if(!nobetListesiOlustur()) {
                    mevcutAdim--;
                    return;
                }
            }
            else if(mevcutAdim === 2) {
                nobetListesiOlustur();
                return;
            }
            
            updateUI();
        }

        // Geri Butonu İşlemi
        function handleGeriBtn() {
            if(mevcutAdim > 0) {
                mevcutAdim--;
                updateUI();
            }
        }

        // UI Güncelleme
        function updateUI() {
            document.querySelectorAll('[id$="Adimi"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(adimlar[mevcutAdim]).classList.remove('hidden');
            document.getElementById('geriBtn').classList.toggle('hidden', mevcutAdim === 0);
            
            document.getElementById('adim1').className = `w-8 h-8 rounded-full flex items-center justify-center ${
                mevcutAdim >= 0 ? 'adim-aktif' : 'adim-pasif'
            }`;
            document.getElementById('adim2').className = `w-8 h-8 rounded-full flex items-center justify-center ${
                mevcutAdim >= 1 ? 'adim-aktif' : 'adim-pasif'
            }`;
            document.getElementById('adim3').className = `w-8 h-8 rounded-full flex items-center justify-center ${
                mevcutAdim >= 2 ? 'adim-aktif' : 'adim-pasif'
            }`;
            
            document.getElementById('devamBtn').innerHTML = 
                mevcutAdim === adimlar.length - 1 ? '<i class="ri-refresh-line mr-2"></i>Yeniden Oluştur' : 'İleri <i class="ri-arrow-right-line ml-2"></i>';
        }

        // Yardım Göster
        function showHelp() {
            alert("KULLANIM KILAVUZU\n\n" +
                  "1. PLANLAMA AYARLARI:\n" +
                  "   - Tarih aralığını belirleyin\n" +
                  "   - Vardiya başına personel sayısını ayarlayın\n" +
                  "   - Nöbet kurallarını tanımlayın\n\n" +
                  "2. PERSONEL YÖNETİMİ:\n" +
                  "   - Yeni Personel ekleyin/düzenleyin\n" +
                  "   - Mazeret günlerini takvimden seçin\n" +
                  "   - Personel listesini oluşturup içe veya dışa aktarın\n\n" +
                  "3. SONUÇ:\n" +
                  "   - Excel'e aktarın veya yeniden oluşturun\n\n" +
                  "ÖNEMLİ:\n" +
                  "- Verileriniz hiçbir şekilde depolanmaz\n" +
                  "- [.xlsx .xls .csv] dosya uzantıları desteklenir.\n" +
                  "- Hafta sonları (Cumartesi/Pazar) otomatik kırmızı renkte gösterilir\n\n" +
                  "HAKKINDA:\n" +
                  "- Author: farukguler.com\n" +
                  "- Version: v4.27");
        }

        // Tarih formatlama
        function formatDate(date) {
            const d = new Date(date);
            return d.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
        }

        // HTML Escape
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Modal İşlemleri
        function kapatModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }
    </script>

<div style="background-color: #95c4ed; padding: 15px; border-radius: 5px; margin-top: 20px; text-align: center;">
<div style="background-color: #95c4ed; padding: 15px; border-radius: 5px; margin-top: 20px; text-align: center;">
        <p>Sağlık çalışanları ve güvenlik güçlerine ithaf edilmiştir.</p> 
        <p>Consecration to healthcare professionals and security forces.</p>
        <p>© 2025 www.farukguler.com - Licenses CC-BY-4.0</p>
        <p>Yaşamak bir ağaç gibi tek ve hür ve bir orman gibi kardeşçesine ❤️😊</p>
        <p>Bu yazılım hakkında istekler, hatalar ve önerileriniz için mail adresim: fguler962@ gmail.com</p>
<a href="https://info.flagcounter.com/qbiJ"><img src="https://s05.flagcounter.com/mini/qbiJ/bg_FFFFFF/txt_000000/border_CCCCCC/flags_0/" alt="Flag Counter" border="0"></a>
    </div>
</body>
</html>

